import random
import os
from flask import Flask, request
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, ContextTypes, filters

# Flask-приложение
app = Flask(__name__)

# Задачи
tasks = [
    {
  "question": "Мужчина 35 лет обратился в поликлинику с жалобами на сильную боль в горле, затруднённое глотание, температуру 39 °C. Осмотр показал гиперемию зева и налеты на миндалинах. Врач диагностировал ангину. Учитывая анамнез (часто забывает принимать таблетки), назначен антибиотик пролонгированного действия. Какой препарат выберете?",
  "answer": "бициллин-3"
    },
    {
  "question": "Ребенок 9 лет с жалобами на боль в горле, температуру 38.5 °C. Диагноз: фарингит. У него в анамнезе тяжелая аллергическая реакция на пенициллины. Врач принимает решение назначить сульфаниламидный препарат с пролонгированным действием. Что назначить?",
  "answer": "сульфадиметоксин"
    },
{
  "question": "Женщина 28 лет обратилась с жалобами на учащенное и болезненное мочеиспускание, мутную мочу. При анализе — бактериурия, лейкоциты. Диагноз — острый цистит. Назначьте уроантисептик, действующий преимущественно в мочевыводящих путях.",
  "answer": "нитроксолин"
},
{
  "question": "На приёме у фельдшера женщина теряет сознание. Артериальное давление в норме, пульс слабый, поверхностное дыхание. Требуется быстрое пробуждение пациента. Какое средство используете для ингаляции?",
  "answer": "нашатырный спирт"
},
{
  "question": "Мужчина 45 лет после операции начал терять сознание, дыхание стало редким. Сознание спутанное. Врач подозревает угнетение дыхательного центра. Какой аналептик можно применить для стимуляции дыхания?",
  "answer": "кордиамин"
},
{
  "question": "Пациент 60 лет госпитализирован с выраженной брадикардией (ЧСС 40), АД снижено. В анамнезе — инфаркт миокарда. Назначьте препарат, блокирующий парасимпатические влияния на сердце.",
  "answer": "атропин"
},
{
  "question": "Пациент с открытоугольной формой глаукомы получил направление к офтальмологу. Необходимо снизить внутриглазное давление. Какой миотик применяется в таких случаях?",
  "answer": "пилокарпин"
},
{
  "question": "Мужчина 50 лет перенёс ЧМТ. Жалуется на ухудшение памяти, головокружения, утомляемость. Врач назначает ноотропное средство, улучшающее метаболизм мозга. Какой препарат это может быть?",
  "answer": "пирацетам"
},
{
  "question": "Пациентка 45 лет жалуется на тяжесть в правом подреберье после еды, запоры. УЗИ показало признаки гипокинетической дискинезии желчевыводящих путей. Какой препарат с желчегонным эффектом назначают в таких случаях?",
  "answer": "аллохол"
},
{
  "question": "У пациента развился приступ наджелудочковой тахикардии. Давление — в пределах нормы. Требуется замедлить сердечный ритм, не влияя резко на АД. Какой блокатор кальциевых каналов применяют в данной ситуации?",
  "answer": "верапамил"
},{
  "question": "Мужчина 58 лет с впервые выявленным повышением давления до 165/100 мм рт.ст. жалуется на головную боль. Назначьте препарат для быстрого снижения давления из группы ингибиторов АПФ.",
  "answer": "каптоприл"
},
{
  "question": "Пациентка жалуется на приступообразную давящую боль за грудиной при физической нагрузке. Диагноз — стенокардия напряжения. Назовите препарат, который следует принять под язык при приступе.",
  "answer": "нитроглицерин"
},
{
  "question": "Пациент с хронической сердечной недостаточностью предъявляет жалобы на отеки ног, одышку при незначительной нагрузке. Назначьте диуретик быстрого действия для снятия отёков.",
  "answer": "фуросемид"
},
{
  "question": "Пациент с острым инфарктом миокарда испытывает сильную загрудинную боль, не снимаемую нитратами. Какой наркотический анальгетик используют для купирования болевого синдрома?",
  "answer": "морфин"
},
{
  "question": "У пациента началась тяжёлая форма аллергической реакции — отёк Квинке. Необходимо быстро снять отек и воспаление. Какой глюкокортикостероид примените в неотложной помощи?",
  "answer": "преднизолон"
},
{
  "question": "Пациент с аллергической крапивницей обратился за помощью. Требуется быстрое снятие зуда и отека. Какой антигистаминный препарат 1 поколения может быть использован?",
  "answer": "хлоропирамин"
},
{
  "question": "Мужчина с сахарным диабетом 1 типа теряет сознание на улице. У него холодный пот, бледность, судороги. Подозревается гипогликемическая кома. Какой препарат в/в примените в неотложной ситуации?",
  "answer": "глюкоза"
},
{
  "question": "Ребенок случайно выпил таблетки из домашней аптечки. Родители вызвали скорую помощь. До приезда бригады решено дать препарат, связывающий токсины в ЖКТ. Что это за средство?",
  "answer": "активированный уголь"
},
{
  "question": "У пациента инфицированная рана с гнойным отделяемым. Требуется промывание антисептическим раствором. Какой препарат подойдёт для этой цели?",
  "answer": "фурацилин"
},
{
  "question": "На приёме у врача пациент внезапно потерял сознание, угнетено дыхание. Обнаружено, что ранее он получил морфин. Назовите препарат-антагонист опиоидов для введения в/в.",
  "answer": "налоксон"
},
{
  "question": "Пациент жалуется на схваткообразные боли в животе, тошноту. При пальпации — болезненность в эпигастрии, возможно спазм гладкой мускулатуры. Какой миотропный спазмолитик назначить?",
  "answer": "дротаверин"
},
{
  "question": "Пациент с гастритом жалуется на тошноту, рвоту и тяжесть после еды. Какой прокинетик и противорвотный препарат можно применить?",
  "answer": "метоклопрамид"
},
{
  "question": "Пациент страдает генерализованной эпилепсией. Приступы судорог повторяются каждые 1–2 недели. Какой противосудорожный препарат используют для профилактического лечения?",
  "answer": "вальпроевая кислота"
},

]

# Состояние пользователей
user_current_tasks = {}

# Токен и адрес
BOT_TOKEN = os.getenv("BOT_TOKEN")  # Установи переменную окружения
WEBHOOK_URL = os.getenv("WEBHOOK_URL")  # URL сайта Render без слэша (например: https://my-bot.onrender.com)

application = Application.builder().token(BOT_TOKEN).build()

# Команда /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("👋 Привет! Я бот по фармакологии. Напиши /quiz чтобы начать викторину.")

# Команда /quiz
async def quiz(update: Update, context: ContextTypes.DEFAULT_TYPE):
    task = random.choice(tasks)
    user_id = update.effective_user.id
    user_current_tasks[user_id] = task
    await update.message.reply_text(f"🧠 Ситуационная задача:\n{task['question']}")

# Обработка ответа
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    user_answer = update.message.text.strip().lower()

    if user_id in user_current_tasks:
        correct_answer = user_current_tasks[user_id]["answer"].lower()
        if user_answer == correct_answer:
            await update.message.reply_text("✅ Верно! Напиши /quiz для следующей задачи.")
        else:
            await update.message.reply_text(f"❌ Неверно. Правильный ответ: {correct_answer}\nНапиши /quiz для следующей задачи.")
        del user_current_tasks[user_id]
    else:
        await update.message.reply_text("Напиши /quiz чтобы начать новую задачу.")

# Регистрируем обработчики
application.add_handler(CommandHandler("start", start))
application.add_handler(CommandHandler("quiz", quiz))
application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

# Webhook endpoint для Telegram
@app.post(f"/{BOT_TOKEN}")
async def webhook(request):
    data = await request.get_data()
    update = Update.de_json(data.decode("utf-8"), application.bot)
    await application.update_queue.put(update)
    return "ok"

# Endpoint для проверки (UptimeRobot)
@app.get("/")
def index():
    return "✅ Бот работает"

# Установка webhook при старте
@app.before_first_request
def set_webhook():
    application.bot.set_webhook(f"{WEBHOOK_URL}/{BOT_TOKEN}")

# Запуск Flask (вместо application.run_polling())
if __name__ == "__main__":
    app.run(port=8000)
