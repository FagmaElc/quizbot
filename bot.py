import os
import random
import asyncio
from threading import Thread
from flask import Flask
from telegram import Update
from telegram.ext import (
    ApplicationBuilder, CommandHandler, MessageHandler,
    ContextTypes, filters
)

# --- Flask для web ---
flask_app = Flask(__name__)

@flask_app.route("/")
def index():
    return "Фармакология Бот живёт!"

def run_flask():
    port = int(os.environ.get("PORT", 5000))
    flask_app.run(host="0.0.0.0", port=port)

# --- Данные ---
# Ситуации с одним правильным ответом
tasks = [
     {
  "question": "Мужчина 35 лет обратился в поликлинику с жалобами на сильную боль в горле, затруднённое глотание, температуру 39 °C. Осмотр показал гиперемию зева и налеты на миндалинах. Врач диагностировал ангину. Учитывая анамнез (часто забывает принимать таблетки), назначен антибиотик пролонгированного действия. Какой препарат выберете?",
  "answer": "бициллин-3"
    },
    {
  "question": "Ребенок 9 лет с жалобами на боль в горле, температуру 38.5 °C. Диагноз: фарингит. У него в анамнезе тяжелая аллергическая реакция на пенициллины. Врач принимает решение назначить сульфаниламидный препарат с пролонгированным действием. Что назначить?",
  "answer": "сульфадиметоксин"
    },
{
  "question": "Женщина 28 лет обратилась с жалобами на учащенное и болезненное мочеиспускание, мутную мочу. При анализе — бактериурия, лейкоциты. Диагноз — острый цистит. Назначьте уроантисептик, действующий преимущественно в мочевыводящих путях.",
  "answer": "нитроксолин"
},
{
  "question": "На приёме у фельдшера женщина теряет сознание. Артериальное давление в норме, пульс слабый, поверхностное дыхание. Требуется быстрое пробуждение пациента. Какое средство используете для ингаляции?",
  "answer": "нашатырный спирт"
},
{
  "question": "Мужчина 45 лет после операции начал терять сознание, дыхание стало редким. Сознание спутанное. Врач подозревает угнетение дыхательного центра. Какой аналептик можно применить для стимуляции дыхания?",
  "answer": "кордиамин"
},
{
  "question": "Пациент 60 лет госпитализирован с выраженной брадикардией (ЧСС 40), АД снижено. В анамнезе — инфаркт миокарда. Назначьте препарат, блокирующий парасимпатические влияния на сердце.",
  "answer": "атропин"
},
{
  "question": "Пациент с открытоугольной формой глаукомы получил направление к офтальмологу. Необходимо снизить внутриглазное давление. Какой миотик применяется в таких случаях?",
  "answer": "пилокарпин"
},
{
  "question": "Мужчина 50 лет перенёс ЧМТ. Жалуется на ухудшение памяти, головокружения, утомляемость. Врач назначает ноотропное средство, улучшающее метаболизм мозга. Какой препарат это может быть?",
  "answer": "пирацетам"
},
{
  "question": "Пациентка 45 лет жалуется на тяжесть в правом подреберье после еды, запоры. УЗИ показало признаки гипокинетической дискинезии желчевыводящих путей. Какой препарат с желчегонным эффектом назначают в таких случаях?",
  "answer": "аллохол"
},
{
  "question": "У пациента развился приступ наджелудочковой тахикардии. Давление — в пределах нормы. Требуется замедлить сердечный ритм, не влияя резко на АД. Какой блокатор кальциевых каналов применяют в данной ситуации?",
  "answer": "верапамил"
},{
  "question": "Мужчина 58 лет с впервые выявленным повышением давления до 165/100 мм рт.ст. жалуется на головную боль. Назначьте препарат для быстрого снижения давления из группы ингибиторов АПФ.",
  "answer": "каптоприл"
},
{
  "question": "Пациентка жалуется на приступообразную давящую боль за грудиной при физической нагрузке. Диагноз — стенокардия напряжения. Назовите препарат, который следует принять под язык при приступе.",
  "answer": "нитроглицерин"
},
{
  "question": "Пациент с хронической сердечной недостаточностью предъявляет жалобы на отеки ног, одышку при незначительной нагрузке. Назначьте диуретик быстрого действия для снятия отёков.",
  "answer": "фуросемид"
},
{
  "question": "Пациент с острым инфарктом миокарда испытывает сильную загрудинную боль, не снимаемую нитратами. Какой наркотический анальгетик используют для купирования болевого синдрома?",
  "answer": "морфин"
},
{
  "question": "У пациента началась тяжёлая форма аллергической реакции — отёк Квинке. Необходимо быстро снять отек и воспаление. Какой глюкокортикостероид примените в неотложной помощи?",
  "answer": "преднизолон"
},
{
  "question": "Пациент с аллергической крапивницей обратился за помощью. Требуется быстрое снятие зуда и отека. Какой антигистаминный препарат 1 поколения может быть использован?",
  "answer": "хлоропирамин"
},
{
  "question": "Мужчина с сахарным диабетом 1 типа теряет сознание на улице. У него холодный пот, бледность, судороги. Подозревается гипогликемическая кома. Какой препарат в/в примените в неотложной ситуации?",
  "answer": "глюкоза"
},
{
  "question": "Ребенок случайно выпил таблетки из домашней аптечки. Родители вызвали скорую помощь. До приезда бригады решено дать препарат, связывающий токсины в ЖКТ. Что это за средство?",
  "answer": "активированный уголь"
},
{
  "question": "У пациента инфицированная рана с гнойным отделяемым. Требуется промывание антисептическим раствором. Какой препарат подойдёт для этой цели?",
  "answer": "фурацилин"
},
{
  "question": "На приёме у врача пациент внезапно потерял сознание, угнетено дыхание. Обнаружено, что ранее он получил морфин. Назовите препарат-антагонист опиоидов для введения в/в.",
  "answer": "налоксон"
},
{
  "question": "Пациент жалуется на схваткообразные боли в животе, тошноту. При пальпации — болезненность в эпигастрии, возможно спазм гладкой мускулатуры. Какой миотропный спазмолитик назначить?",
  "answer": "дротаверин"
},
{
  "question": "Пациент с гастритом жалуется на тошноту, рвоту и тяжесть после еды. Какой прокинетик и противорвотный препарат можно применить?",
  "answer": "метоклопрамид"
},
{
  "question": "Пациент страдает генерализованной эпилепсией. Приступы судорог повторяются каждые 1–2 недели. Какой противосудорожный препарат используют для профилактического лечения?",
  "answer": "вальпроевая кислота"
},
]

# Для хранения текущей задачи пользователя: user_id -> task index
active_tasks = {}

# --- Хэндлеры ---

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    task = random.choice(tasks)
    active_tasks[user_id] = task
    await update.message.reply_text(
        f"Ситуационная задача:\n\n{task['situation']}\n\n"
        "Напиши название правильного препарата (на русском, строчными буквами)."
    )

async def check_answer(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    text = update.message.text.strip().lower()

    if user_id not in active_tasks:
        await update.message.reply_text(
            "Чтобы получить задачу, напиши команду /start"
        )
        return

    correct_answer = active_tasks[user_id]["answer"].lower()

    if text == correct_answer:
        await update.message.reply_text("✅ Правильно! Молодец!")
        # Убираем задачу, чтобы не отвечать повторно
        del active_tasks[user_id]
    else:
        await update.message.reply_text("❌ Неправильно, попробуй ещё раз!")

def main():
    Thread(target=run_flask).start()

    TOKEN = os.environ["BOT_TOKEN"]
    app = ApplicationBuilder().token(TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, check_answer))

    print("🧪 Фармакология Бот запущен!")
    app.run_polling()

if __name__ == "__main__":
    main()
